
/**
 * Potential user selector module.
 *
 * @module     enrol_manual/form-potential-user-selector
 * @copyright  2016 Damyon Wiese
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define(['jquery','core/ajax','core/templates','core/str'],function($,Ajax,Templates,Str){return{processResults:function(selector,results){var users=[];if($.isArray(results)){$.each(results,function(index,user){users.push({value:user.id,label:user._label})});return users}else{return results}},transport:function(selector,query,success,failure){var promise;var courseid=$(selector).attr('courseid');var userfields=$(selector).attr('userfields').split(',');if(typeof courseid==="undefined"){courseid='1'}
var enrolid=$(selector).attr('enrolid');if(typeof enrolid==="undefined"){enrolid=''}
var siteid=$(selector).attr('siteid');if(typeof siteid==="undefined"){siteid=''}
var perpage=parseInt($(selector).attr('perpage'));if(isNaN(perpage)){perpage=100}
promise=Ajax.call([{methodname:'local_qubitsuser_get_potential_users',args:{courseid:courseid,enrolid:enrolid,siteid:siteid,search:query,searchanywhere:!0,page:0,perpage:perpage+1}}]);promise[0].then(function(results){var promises=[],i=0;if(results.length<=perpage){const profileRegex=/^profile_field_(.*)$/;$.each(results,function(index,user){var ctx=user,identity=[];$.each(userfields,function(i,k){const result=profileRegex.exec(k);if(result){if(user.customfields){user.customfields.forEach(function(customfield){if(customfield.shortname===result[1]){ctx.hasidentity=!0;identity.push(customfield.value)}})}}else{if(typeof user[k]!=='undefined'&&user[k]!==''){ctx.hasidentity=!0;identity.push(user[k])}}});ctx.identity=identity.join(', ');promises.push(Templates.render('enrol_manual/form-user-selector-suggestion',ctx))});return $.when.apply($.when,promises).then(function(){var args=arguments;$.each(results,function(index,user){user._label=args[i];i++});success(results);return})}else{return Str.get_string('toomanyuserstoshow','core','>'+perpage).then(function(toomanyuserstoshow){success(toomanyuserstoshow);return})}}).fail(failure)}}})